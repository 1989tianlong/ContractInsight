# 统一合同平台 - 整体架构设计

## 1. 概述

### 1.1 项目背景
企业在日常经营中产生大量合同，来源多样化（线上电子签、线下扫描件），缺乏统一的管理平台导致：
- 合同数据孤岛，无法进行全局检索和分析
- 不同业务域的合同标准不统一
- 权限管理混乱，审计困难
- 缺乏智能化提取和分析能力

### 1.2 设计目标
构建一套**统一合同平台 + 多域服务层 + 数据/AI基座**，实现：
- ✅ 多来源合同统一接入（扫描件、电子签、PDF、图片）
- ✅ 智能化合同信息提取与质检
- ✅ 多租户/多业务域隔离
- ✅ 企业级权限、审计、工作流能力
- ✅ 高性能合同存储与检索

---

## 2. 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              接入层 (Contract Gateway)                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │  扫描件上传  │  │  电子签对接  │  │   API接入   │  │  批量导入   │                 │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            合同接入网关 (Ingestion Gateway)                          │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │    文件解析    │  │   OCR/质检     │  │  元数据标准化   │  │   业务域标识   │    │
│  │  PDF/IMG/DOC   │  │  Layout/Table  │  │  Schema映射    │  │  Tenant路由    │    │
│  └────────────────┘  └────────────────┘  └────────────────┘  └────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    ▼                     ▼                     ▼
┌───────────────────────┐  ┌───────────────────────┐  ┌───────────────────────┐
│   合同提取服务         │  │   合同存储服务         │  │   合同查询服务         │
│   Contract Extract    │  │   Contract Store      │  │   Contract Query      │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │  NLP实体抽取    │  │  │  │  元数据存储     │  │  │  │  全文检索       │  │
│  │  关键条款识别   │  │  │  │  (MySQL/PG)    │  │  │  │  (ES/Meilisearch)│ │
│  │  模板匹配      │  │  │  │  ┌─────────────┐ │  │  │  ├─────────────────┤  │
│  │  合同分类      │  │  │  │  │ 文件存储    │ │  │  │  │  条件查询       │  │
│  │  风险识别      │  │  │  │  │ (OSS/MinIO) │ │  │  │  │  聚合分析       │  │
│  └─────────────────┘  │  │  │  └─────────────┘ │  │  │  │  向量检索       │  │
└───────────────────────┘  │  └─────────────────┘  │  │  └─────────────────┘  │
                           └───────────────────────┘  └───────────────────────┘
                                          │
┌─────────────────────────────────────────┴─────────────────────────────────────────┐
│                              旁路服务层 (Sidecar Services)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  权限服务    │  │  审计服务    │  │  工作流引擎  │  │  多租户/业务域隔离   │   │
│  │  RBAC/ABAC   │  │  AuditLog    │  │  BPMN/状态机 │  │  Tenant Isolation   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└───────────────────────────────────────────────────────────────────────────────────┘
                                          │
┌─────────────────────────────────────────┴─────────────────────────────────────────┐
│                              数据/AI 基座 (Data & AI Platform)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  数据湖/仓   │  │  向量数据库  │  │   LLM服务    │  │    模型训练平台      │   │
│  │  DW/Lake     │  │  Milvus/PG   │  │  OpenAI/私有 │  │    MLOps Pipeline   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└───────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心设计原则

### 3.1 分层解耦
| 层级 | 职责 | 技术栈 |
|------|------|--------|
| 接入层 | 多渠道合同接入、协议适配 | API Gateway, WebSocket |
| 网关层 | 解析、OCR、标准化、路由 | 消息队列 + 微服务 |
| 核心服务层 | 提取、存储、查询 | 领域服务 + 事件驱动 |
| 旁路服务层 | 权限、审计、工作流 | 可插拔组件 |
| 数据基座 | 数据存储、AI能力 | 湖仓一体 + MLOps |

### 3.2 多租户隔离策略

```
┌─────────────────────────────────────────────────────────────┐
│                    多租户架构模式                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              应用层隔离 (Application Level)          │   │
│  │  • 租户ID (tenant_id) 贯穿所有请求                   │   │
│  │  • API Gateway 统一鉴权与租户识别                    │   │
│  │  • 业务域标识 (domain_code) 区分不同业务线           │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              数据层隔离 (Data Level)                 │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────────────┐  │   │
│  │  │共享数据库│  │独立Schema│  │   独立数据库实例    │  │   │
│  │  │行级隔离 │  │逻辑隔离 │  │   物理隔离(VIP)    │  │   │
│  │  │(中小租户)│  │(标准租户)│  │   (大客户/合规)    │  │   │
│  │  └─────────┘  └─────────┘  └─────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 事件驱动架构

所有合同生命周期变更通过事件总线异步传递：

```
Contract Events:
├── contract.uploaded          # 合同上传
├── contract.ocr.completed     # OCR完成
├── contract.extracted         # 信息提取完成
├── contract.validated         # 质检通过
├── contract.stored            # 存储完成
├── contract.approved          # 审批通过
├── contract.expired           # 合同到期
└── contract.archived          # 合同归档
```

---

## 4. 技术选型建议

### 4.1 基础设施层
| 组件 | 推荐方案 | 备选方案 |
|------|----------|----------|
| 容器编排 | Kubernetes | Docker Swarm |
| 服务网格 | Istio | Linkerd |
| API网关 | Kong / APISIX | Envoy |
| 消息队列 | Apache Kafka | RabbitMQ, Pulsar |
| 配置中心 | Nacos / Consul | Apollo |

### 4.2 数据存储层
| 场景 | 推荐方案 | 说明 |
|------|----------|------|
| 元数据存储 | PostgreSQL | JSONB支持灵活schema |
| 文件存储 | MinIO / 阿里云OSS | S3兼容 |
| 全文检索 | Elasticsearch | 高性能全文 + 聚合 |
| 向量存储 | Milvus / pgvector | 语义检索 |
| 缓存 | Redis Cluster | 热点数据 + 分布式锁 |
| 数据湖 | Apache Iceberg + Spark | 湖仓一体 |

### 4.3 AI/ML层
| 能力 | 推荐方案 |
|------|----------|
| OCR引擎 | PaddleOCR / 阿里云OCR |
| 版面分析 | LayoutLMv3 / DocParser |
| NLP抽取 | 私有化LLM + Prompt Engineering |
| 向量化 | BGE / M3E Embedding |
| 模型服务 | Triton Inference Server |

### 4.4 开发框架
| 语言 | 推荐框架 |
|------|----------|
| Java | Spring Boot 3 + Spring Cloud |
| Python | FastAPI (AI服务) |
| Go | Gin / Kratos (高性能网关) |
| 前端 | React + Ant Design Pro |
